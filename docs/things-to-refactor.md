# tsundo-cleaner リファクタリング項目

## 1. アーキテクチャ上の問題

### 1.1. データベース接続管理の問題
- **問題点**: クエリごとに接続を開いて閉じる設計になっており、パフォーマンス面で非効率
- **該当箇所**: `database.ts`、各サービスクラスのメソッド
- **改善案**: コネクションプールを導入し、接続の再利用を図る

### 1.2. サービスの責務分離が不明確
- **問題点**: `bookService.ts`に推薦ロジック(`getWeeklyRecommendation`)が含まれている
- **該当箇所**: `bookService.ts`
- **改善案**: 設計書通りに`RecommendationService`を分離し、責務を明確化する

### 1.3. ハードコードされたパス
- **問題点**: 特定のユーザー環境に依存するパスがハードコードされている
- **該当箇所**: `database.ts`の`DEFAULT_DB_PATH`
- **改善案**: 設定ファイルや環境変数を使用して外部化する

## 2. データモデルの問題

### 2.1. 型の不一致
- **問題点**: モデル定義では`boolean`型だが、クエリでは文字列として扱われている
- **該当箇所**: `Book`モデルの`exist_in_Sophia`と`exist_in_UTokyo`
- **改善案**: 実データに合わせて型定義を修正するか、値の変換処理を追加

### 2.2. 不完全な型定義
- **問題点**: `BookType`の意味や違いがコメントで説明されていない
- **該当箇所**: `Book.ts`の`BookType`定義
- **改善案**: JSDocコメントを追加して型の意味を明確化

## 3. エラーハンドリングの問題

### 3.1. エラーメッセージの不十分な詳細
- **問題点**: エラー時に詳細なコンテキスト情報が提供されていない
- **該当箇所**: 各コントローラーの`catch`ブロック
- **改善案**: エラーの種類や原因に応じた詳細メッセージを提供

### 3.2. 例外の型チェック不足
- **問題点**: 発生した例外の型をチェックせず、すべてのエラーを同様に処理
- **該当箇所**: 各サービスとコントローラーの`catch`ブロック
- **改善案**: `instanceof`を使用した例外の型チェックと、型に応じた処理の分岐

## 4. パフォーマンスの問題

### 4.1. 非効率なデータベースクエリ
- **問題点**: すべてのデータをメモリにロードしてから処理している
- **該当箇所**: `SimilarityService.getSimilarBooks`など
- **改善案**: データベース側でフィルタリングを行うSQLを最適化

### 4.2. TF-IDFの実装効率
- **問題点**: 類似度計算が非効率で、すべての文書に対して個別に計算している
- **該当箇所**: `findSimilarByDescription`メソッド
- **改善案**: 一度に複数文書の類似度を計算するアルゴリズムに改善

## 5. セキュリティの問題

### 5.1. SQL Injectionの可能性
- **問題点**: ユーザー入力が直接SQL文に結合され、検証が不十分
- **該当箇所**: `type`パラメータを使用するクエリ（複数箇所）
- **改善案**: パラメータの検証強化、許可リストによる制限

## 6. その他の設計上の問題

### 6.1. フロントエンドとバックエンドの重複コード
- **問題点**: `Book`インターフェースが重複定義されている
- **該当箇所**: `backend/src/models/Book.ts`と`frontend/src/types/Book.ts`
- **改善案**: 共通の型定義を作成し、両方から参照する

### 6.2. 共通処理の抽象化不足
- **問題点**: エラーハンドリングなどの共通処理が重複している
- **該当箇所**: 各サービスクラスのメソッド
- **改善案**: ユーティリティ関数や高階関数を使用した抽象化

### 6.3. テストコードの欠如
- **問題点**: テストコードが存在せず、品質保証が不十分
- **改善案**: 単体テスト・統合テストの導入
