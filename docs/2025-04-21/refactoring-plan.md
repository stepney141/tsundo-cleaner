# tsundo-cleaner リファクタリング計画

## 問題点の概要

ソースコードの分析結果、以下の主な問題点が見つかりました。これらの問題は保守性、拡張性、パフォーマンス、セキュリティの観点から改善が必要です。

## 1. アーキテクチャの過剰な複雑さ

### 問題点
- 小規模アプリケーションに対して過度に複雑な階層構造
- Controller → Service → Database の複雑な依存関係
- 機能ごとに分割されすぎたサービスクラス
- オブジェクト指向と関数型のアプローチが混在

### 解決策
- サービス層の簡素化と関数型アプローチの強化
- 純粋関数を優先した実装への移行
- より平坦な構造への再設計
- ビジネスロジックの集約と単純化

## 2. 型定義の重複

### 問題点
- バックエンドとフロントエンドで同一の型定義が重複
- 変更時の同期問題のリスク
- 型の整合性を保証するメカニズムの欠如

### 解決策
- 共有型定義の導入
- モノレポ構造での型の共有
- または型定義ファイルの自動生成による一元管理
- フロントエンドでのDB型定義の削除

## 3. データベース設計と使用上の問題

### 問題点
- 真偽値を "Yes"/"No" 文字列として格納（非効率）
- データ変換処理の冗長性
- シングルトンパターンによるデータベース接続管理
- テスト時のモック困難性
- クエリの最適化不足（SELECT * の使用など）
- ページネーション機能の欠如

### 解決策
- 標準的なboolean型（0/1）の使用
- モデル変換ロジックの簡素化または排除
- 依存性注入を活用したデータベース接続管理
- クエリの最適化（必要なカラムのみ選択）
- ページネーション機能の実装
- インデックス最適化

## 4. エラーハンドリングの不一貫性

### 問題点
- コントローラーごとに個別のエラーハンドリング
- エラーメッセージの不統一
- 開発者向けと利用者向けメッセージの混在
- エラー種別に応じた適切なHTTPステータスコードの欠如

### 解決策
- 集中型エラーハンドリングの導入
- 構造化されたエラーレスポンスの標準化
- エラー種別に応じたHTTPステータスコードの適用
- 開発者向けログと利用者向けメッセージの分離

## 5. セキュリティ上の懸念

### 問題点
- CORSの無制限設定
- SQL文やパラメータの詳細なエラーログ
- 入力検証の重複実装

### 解決策
- 適切なCORS設定（本番環境では制限を設ける）
- 安全なエラーログ出力（機密情報の除外）
- 一元化された入力検証の実装

## 6. フロントエンドの最適化不足

### 問題点
- データキャッシュ機能の欠如
- API呼び出しの冗長性
- 環境変数の型安全性の不足

### 解決策
- データキャッシュ機構の実装
- React Query などのライブラリ活用
- 環境変数の型定義強化

## 実装計画

### フェーズ1: 型定義の整理と共有化
1. 共通の型定義モジュールの作成
2. バックエンド・フロントエンド間の型共有の仕組み構築
3. フロントエンドでのDB型定義の整理

### フェーズ2: バックエンドアーキテクチャの改善
1. データベース接続管理の改善（依存性注入の導入）
2. サービス層の再設計（関数型アプローチの強化）
3. 集中型エラーハンドリングの実装
4. データモデルと変換ロジックの最適化

### フェーズ3: クエリと性能最適化
1. SQLクエリの最適化
2. ページネーション機能の実装
3. インデックス設計の見直し

### フェーズ4: フロントエンド最適化
1. データフェッチの最適化（キャッシュ導入）
2. エラーハンドリング強化
3. 環境変数の型安全性向上

### フェーズ5: セキュリティ強化
1. CORS設定の適切な制限
2. 安全なエラーログ出力の実装
3. 入力検証の一元化

## .clinerules への整合性

リファクタリングにあたり、プロジェクトの `.clinerules` に記載された以下の方針を重視します：

- 関数型アプローチ (FP)
  - 純粋関数を優先する
  - 不変データ構造を使用する
  - 副作用を分離する
  - 型安全性を確保する

これらの原則に沿ってコードを修正し、より堅牢で保守しやすいアプリケーションを目指します。
